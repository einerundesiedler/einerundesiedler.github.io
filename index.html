<meta charset="UTF-8"> 
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' />
<head>
<style>
    
	body {	
		margin: 0;
		padding: 0;
		background-color: #f1f1f1;
	}
</style>
</head>
<body>
<script>RELEASE=true;</script>
<script>VERSION="12/26/2020, 19:43:07";</script>
	<script src="https://cdn.jsdelivr.net/npm/phaser@3.50.0/dist/phaser.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase.js"></script>
<script>
function array_remove_duplicates(value, index, self) {
  return self.indexOf(value) === index;
}

function shuffle_array(array) {
    var currentIndex = array.length, temporaryValue, randomIndex;
  
    // While there remain elements to shuffle...
    while (0 !== currentIndex) {
  
      // Pick a remaining element...
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex -= 1;
  
      // And swap it with the current element.
      temporaryValue = array[currentIndex];
      array[currentIndex] = array[randomIndex];
      array[randomIndex] = temporaryValue;
    }
  
    return array;
  }
</script>
<script>
class Button {
    constructor(scene, x, y, text, onClick) {

        this.bg = scene.add.image(x, y, 'button').setInteractive();
        this.bg.on('pointerup', onClick);

        this.textfield = scene.add.text(x-60, y, text, { fontSize: '24px', fill: '#000' });
    }

    set text(val) {
        this.textfield.text = val;
    }
}
</script>
<script>
class Card{
    constructor(scene, card_data) {
        this.id = card_data.id;
        this.image = scene.add.image(100, 100, card_data.src).setInteractive();
        this.image.setScale(0.5);
        
        scene.input.setDraggable(this.image);
        scene.input.on('drag',  (pointer, gameObject, dragX, dragY) => { this.onDrag(this, dragX, dragY); });
        scene.input.on('dragend', () => { this.onDragEnd(this); });
    }

    moveTo(x, y, sync) {
        this.image.x = x;
        this.image.y = y;

        if (sync == true) {
            this.sync();
        }
    }

    onDrag(card, dragX, dragY) {
        card.moveTo(dragX, dragY);
    }

    onDragEnd() {
        this.sync();
    }

    sync() {
        console.log("TODO: trigger sync card " + this.id + " event");
    }
}
</script>
<script>


class CardDeck {
    constructor(card_back)  {
        this.cards = [];
        this.card_back = card_back;
        this.hover = false;
    }

    set_cards(cards) {
        this.cards = cards;
        this.shuffle();
    }

    add_to_scene(scene, x, y) {
        this.scene = scene;
        this.obj = scene.add.image(x, y, this.card_back).setInteractive();
        this.textfield = scene.add.text(x-60, y-10, "", { fontSize: '22px', fill: '#fff' });

        this.obj.setScale(0.5);
        
        this.obj.on('pointerup', () => this.onDeckClick(this)); 
        this.obj.on('pointerover', () => this.onPointerOver(this)); 
        this.obj.on('pointerout', () => this.onPointerOut(this)); 
    }

    onDeckClick() {
        this.scene.main.onDeckClick(this);  
    }

    onPointerOver() {
        this.hover = true;
        this.update();
    }

    onPointerOut() {
        this.hover = false;
        this.update();
    }

    update() {
        if (this.hover) {
            this.obj.setTint(0x555555);
        } else {
            this.obj.clearTint();
        }

        this.textfield.text = this.hover ? this.num_cards + " Karten" : "";
    }
    
    get num_cards() {
        return this.cards.length;
    }

    add_card(data) {
        this.cards.push(data);
    }

    remove_card(id) {
        this.cards = this.cards.filter(card => card.id != id);
    }

    shuffle() {   
        this.cards = shuffle_array(this.cards);
    }

    draw_card() {
        var card = this.cards.pop();
        this.update();
        return card;
    }
}

// call during scene.preload()
// loads all card images from json asset list
function load_card_images(scene, json) {
    var urls = json.cards.map(card => card.src).filter(array_remove_duplicates);
    urls = json.card_backs.concat(urls);

    urls.forEach(url => {
        scene.load.image(url, ASSET_PATH + "cards/" + url);
    });

}

function create_decks(scene) {
    var y_start = 450;

    scene.main.decks = {};
    scene.main.decks.events = new CardDeck("back_event.png");
    scene.main.decks.events.add_to_scene(scene, 100, y_start);
    
    scene.main.decks.cities = new CardDeck("back_city.png");
    scene.main.decks.cities.add_to_scene(scene, 250, y_start);
    
    scene.main.decks.roads = new CardDeck("back_road.png");
    scene.main.decks.roads.add_to_scene(scene, 400, y_start);

    scene.main.decks.villages = new CardDeck("back_village.png");
    scene.main.decks.villages.add_to_scene(scene, 550, y_start);

    scene.main.decks.environments = new CardDeck("back_environment.png");
    scene.main.decks.environments.add_to_scene(scene, 700, y_start);
    
    scene.main.decks.extensions = [];

    for(var i = 0; i < 5; i++) {
        scene.main.decks.extensions.push(new CardDeck("back_extension.png"));
        scene.main.decks.extensions[i].add_to_scene(scene, 850 + i * 150, y_start );
    }
}

function init_decks_from_cardlist(scene, json) {
    var card_data = json.cards;

    

    for (var i = 0; i < card_data.length; i++) {
        card_data[i].x = -200;
        card_data[i].y = -200;
    }

    scene.main.decks.events.set_cards(card_data.filter(card => card.type == "EVENT"));
    scene.main.decks.cities.set_cards(card_data.filter(card => card.type == "CITY"));
    scene.main.decks.roads.set_cards(card_data.filter(card => card.type == "ROAD"));
    scene.main.decks.villages.set_cards(card_data.filter(card => card.type == "VILLAGE"));
    scene.main.decks.environments.set_cards(card_data.filter(card => card.type == "ENVIRONMENT"));

    var card_extensions = shuffle_array(card_data.filter(card => card.type == "EXTENSION"));
    var num_cards = Math.ceil(card_extensions.length / 5);

    for(var i = 0; i < 5; i++) {
        var cards = card_extensions.slice(i*num_cards, Math.min((i+1)*num_cards, card_extensions.length));
        scene.main.decks.extensions[i].set_cards(cards);
    }

}
</script>
<script>
ASSET_PATH = !RELEASE ? "assets/" : "https://raw.githubusercontent.com/einerundesiedler/einerundesiedler.github.io/master/assets/";

var config = {
    type: Phaser.AUTO,
    width: 1920,
    height: 1080,
    backgroundColor: "#ffb",
    scene: {
        preload: preload,
        create: create,
        update: update,
        render: render
    }
};

var game = new Phaser.Game(config);

function preload ()
{
    this.load.once('load', (fileObj) => onLoaded(this, fileObj));
    this.load.json('cardlist', ASSET_PATH+'cardlist.json');

    this.load.image('button', ASSET_PATH+"ui/button.png");
}

function onLoaded(scene, fileObj) {
    
    switch(fileObj.key) {
        case "cardlist":
            load_card_images(scene, JSON.parse(fileObj.xhrLoader.response));
            break;
    } 
}


function create ()
{
    this.add.text(2, 2, 'version: ' + VERSION, { fontSize: '12px', fill: '#000' });

    // ------------------- GAME LOOP ----------------
    this.main = new GameLoop(this);
    create_decks(this);
    init_decks_from_cardlist(this, this.cache.json.get('cardlist'));


    // ------------------- UI ----------------
    this.ui = {};
    this.ui.btn_newgame = new Button(this, 650, 20, "new game", this.main.onNewGameClick);
    this.ui.btn_player = new Button(this, 800, 20, "join", this.main.onPlayerButtonClick);

    // --------------- SANDBOX


    // indexing of object properties
    var testobj = {};
    testobj.test = "asd";
    console.log(testobj["test"]);


    var card_test = new Card(this, this.cache.json.get('cardlist').cards[50]);
    card_test.moveTo(200, 200);

}

function update ()
{
}


function render () 
{

}




class GameLoop {
    constructor(scene)  {
        this.scene = scene;
        this.playerID = 0;
    }

    onNewGameClick() {
        console.log("TODO: new game");
    }

    onPlayerButtonClick() {
        this.playerID = this.playerID == 1 ? 2 : 1;
        this.scene.ui.btn_player.text = "player: " + this.playerID;
    }

    onDeckClick(deck) {
        console.log("deck clicked -> add card to player");
        deck.draw_card();
    }
}

class GameState {
    constructor() {
        this.player1 = [];
        this.player2 = [];

        this.events = [];
        this.cities = [];

    }
}
</script>
</body>